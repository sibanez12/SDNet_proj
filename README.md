
# Overview

A simple Vivado project to test SDNet based on the provided example designs.

# Test P4 Program Description

The test P4 program is called lnic_v1.p4. The intended functionality is pretty
easy to describe: if a packet arrives with the `nfmeta.ingress_id` field set then
remove the packet's "apphdr" and add Ethernet, IP, and LNIC headers. If a packet
arrives with the `nfmeta.ingress_id` field unset then remove the packet's
Ethernet, IP, and LNIC headers and add an "apphdr".

The test data for the simulation consists of 2 packets:
1. An Ethernet/IP/LNIC packet with `nfmeta.ingress_id = 0`. These headers should
be removed and the "apphdr" should be inserted.
2. An "apphdr" pkt with `nfmeta.ingress_id = 1`. The "apphdr" should be removed
and Ethernet/IP/LNIC headers should be inserted.

# Building

Building the project consists of 2 steps:

1. Run a script to generate the input / expected output packets and metadata.
The expected output packets and metadata are generated by running the SDNet
behavioral model.
2. Run a TCL script to build the Vivado project.

Here are the steps:
```
$ cd p4src/lnic_v1/
$ ./gen_traffic_inout.sh
$ cd ../../scripts/
$ vivado -mode batch -source build_proj.tcl
```

# Run Simulation

1. Open up the project with the Vivado GUI.
2. Click "Run Simulation" in the Flow Navigator.
3. Add signals of interest to the waveform.
4. Click "Run All" (the play button).

# SDNet Issues

This section describes SDNet issues I have encountered so far.

## Deparser Issue

This issue shows up when the program attempts to remove the
incomming packet's apphdr and insert Ethernet, IP, and LNIC
headers. This issue occurs when using a 512-bit datapath.

Here is the simulation output:
```
** Info: Packet 1 data OK (tlast, tkeep, tdata) = (1, 0000000000ffffff, 0844332211080100320000450008088877665508084433221108000000000000100034120302010a00000000000000000000000000000000100034120302010a) at time           1314000000 ps
** Info: Packet 1 metadata OK (user_metadata) = (000000000000100000010) at time           1314000000 ps
** Error: Packet mismatch in packet 2 at time 1330000 ps
  - Expected (tlast, tkeep, tdata) = (1, ffffffffffffffff, 0000000000000000000000000000000000000000000010000000341200000302010a0100000a0000994000000100320000450008084433221108088877665508)
  - Captured (tlast, tkeep, tdata) = (1, ffffffffffffffff, 00000000000000000000000000000000100034120302010a0000000000000302010a0100000a0000994000000100320000450008084433221108088877665508)
** Info: Packet 2 metadata OK (user_metadata) = (200000000000000000000) at time           1330000000 ps
** Info: Finished checker
** Info: TEST FAILED!
  - 1 packet words mismatches.
  - 0 metadata words mismatches.
  - 2 packets sent.
  - 2 packets received.
** Info: Stopping simulation at 1335000 ps
```

## 64-bit Datapath Issue

This issue occurs when using a 64-bit datapath. In this
case, both packets have errors:

```
** Error: Packet mismatch in packet 1 at time 1358000 ps
  - Expected (tlast, tkeep, tdata) = (0, ff, 100034120302010a)
  - Captured (tlast, tkeep, tdata) = (0, ff, 000808887766010a)
** Info: Packet 1 metadata OK (user_metadata) = (000000000000100000010) at time           1358000000 ps
** Info: Packet 1 data OK (tlast, tkeep, tdata) = (0, ff, 0000000000000000) at time           1362000000 ps
** Info: Packet 1 data OK (tlast, tkeep, tdata) = (1, ff, 0000000000000000) at time           1366000000 ps
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (0, ff, 1108088877665508) at time           1382000000 ps
** Info: Packet 2 metadata OK (user_metadata) = (200000000000000000000) at time           1382000000 ps
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (0, ff, 0045000808443322) at time           1386000000 ps
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (0, ff, 9940000001003200) at time           1390000000 ps
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (0, ff, 010a0100000a0000) at time           1394000000 ps
** Error: Packet mismatch in packet 2 at time 1398000 ps
  - Expected (tlast, tkeep, tdata) = (0, ff, 0000341200000302)
  - Captured (tlast, tkeep, tdata) = (0, ff, 1000341203020302)
** Error: Packet mismatch in packet 2 at time 1402000 ps
  - Expected (tlast, tkeep, tdata) = (0, ff, 0000000000001000)
  - Captured (tlast, tkeep, tdata) = (0, ff, 100034120302010a)
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (0, ff, 0000000000000000) at time           1406000000 ps
** Info: Packet 2 data OK (tlast, tkeep, tdata) = (1, ff, 0000000000000000) at time           1410000000 ps
** Info: Finished checker
** Info: TEST FAILED!
  - 3 packet words mismatches.
  - 0 metadata words mismatches.
  - 2 packets sent.
  - 2 packets received.
** Info: Stopping simulation at 1415000 ps
```

